<html>
    <head>
        <meta charset="utf-8" name="viewport" content="width=device-width,user-scalable=no">
		<style>
			body { margin: 0; }
			svg {
				display: block;
				width: 100vmin;
				height: 100vmin;
				margin: auto;
			}
		</style>
        <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
        <script type="text/javascript" src="js/snap.svg-min.js"></script>
        <script type="text/javascript" src="js/accessibility.js"></script>
    </head>
    <body oncontextmenu="return false;">
        <svg viewbox='0 0 100 100'></svg>
        <script>
            function makeHex( radius ) {
                var hexVectors = [];
                for(var i=0; i<6; i+=1) {
                    hexVectors.push( 
                        innerRadius * Math.sin( i * Math.PI / 3 ), 
                        innerRadius * Math.cos( i * Math.PI / 3 )
                    )
                }

                var hex = s.polygon(hexVectors);
                hex.attr({
                    "fill-opacity": 0,
                    stroke: colourScheme.stroke,
                    strokeWidth: 0.5,
                    //filter: s.filter(Snap.filter.shadow( 0, 0, 1, "#fff", 0.3 )),
                });

                return hex;
            }

            function defaultMouseover() { this.animate({ 'fill-opacity': 1 }, 300, mina.easein); }
            function defaultMouseout() { this.animate({ 'fill-opacity': this.data( 'mouseOut' ) }, 300, mina.easeout); }
            function onClick( ev ) { onLeftClick.apply( this, ev ); }
            function onDoubleClick( ev ) { onRightClick.apply( this, ev ); }

            function onLeftClick( ev ) {
                if( this.data( 'state' ) == 'blank' ) {
                    this.data( 'state', 'mine' )
                    this.data( 'mouseOut', 0.8 );
                    this.attr({'fill': this.data( 'mineFill' )}); 
                } else if( this.data( 'state' ) == 'mine' ) {
                    this.data( 'state', 'blank' )
                    this.data( 'mouseOut', 0 );
                    this.attr({'fill': this.data( 'blankFill' )}); 
                } 
            }

            function onRightClick( ev ) {
                if( this.data( 'state' ) == 0 ) {
                    this.data( 'state', 'flag' )
                    this.data( 'mouseOut', 0.8 );
                    this.attr({'fill': this.data( 'flagFill' )}); 
                } else if( this.data( 'state' ) == 'flag' ) {
                    this.data( 'state', 'blank' )
                    this.data( 'mouseOut', 0 );
                    this.attr({'fill': this.data( 'blankFill' )}); 
                } 
            }
    
            function makeGrid( innerRadius, outerRadius ) {
                var tmp_hex = makeHex( innerRadius );
                var hexes = [];
                for( var h=-outerRadius; h<=outerRadius; h=h+1 ) {
                    var H = Math.abs( h );
                    for( var j=-outerRadius; j<=outerRadius; j=j+1 ) {
                        var J = Math.abs( j );
                        if( Math.abs( h + j ) > outerRadius)
                            continue;
                        var x = cx + h * _h + j * _j[ 0 ];
                        var y = cy + j * _j[ 1 ];
                        var hex = tmp_hex.clone();
                        var m = hex.transform().localMatrix;
                        m.translate( x, y );
                        hex.transform( m ); 
                        hexes.push( hex );

                        hex.data( 'state', 'blank' );
                        hex.data( 'mouseOut', 0 );

                        hex.mouseover( defaultMouseover )
                           .mouseout( defaultMouseout )
                           .click( onClick )
                           .dblclick( onDoubleClick );

                        var updateColour = function( h ) { 
                            return function( scheme ) { 
                                h.attr({ 'stroke': scheme.stroke }); 
                                h.data( 'blankFill', scheme.blankFill );
                                h.data( 'flagFill', scheme.flagFill );
                                h.data( 'freeFill', scheme.freeFill );
                                h.data( 'mineFill', scheme.mineFill );
                                
                                h.attr( 'fill', h.data( h.data( 'state' ) + 'Fill' ) );
                            }
                        }
                        eve.on( 'updateColourScheme', updateColour( hex ) );
                    }
                }
                tmp_hex.remove();
                return hexes;
            }

            var outerRadius = 6; 
            var width = 100;
            var cx = 50;
            var cy = 50;

            var _j = [];
            var innerRadius, outerRadius, _h;
            innerRadius = 0.5 * ( width - 1 ) / ( ( 2 * outerRadius + 1 ) * Math.cos( Math.PI / 6 ) );
            _h = 2 * innerRadius * Math.cos( Math.PI / 6 );
            _j[ 0 ] = innerRadius * Math.cos( Math.PI / 6 );
            _j[ 1 ] = 2 * _j[ 0 ] * Math.cos( Math.PI / 6 );
        
            var s, hexOutlineColour, hexes;
            $().ready( function() {
                s = Snap( 'svg' );
                hexes = makeGrid( innerRadius, outerRadius );
                eve( 'updateColourScheme', "self", colourScheme );
            }); 
        </script>
	</body>
</html>
